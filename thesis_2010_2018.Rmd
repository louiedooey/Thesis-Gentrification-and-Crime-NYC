---
title: "Thesis 2010-2018 Test"
output: html_notebook
---


```{r cache = TRUE}
# needed for fread
library(data.table)

# the dataset that takes forever to load
nypd  <- fread("data/NYPD-2/NYPD.csv", header = TRUE)

# functions located in another R sheet
source("thesis_code_functions.R")
```

```{r}
# packages required

library(ggplot2)
library(maptools)
library(rgdal)
library(showtext)
library(ggthemes)
library(hrbrthemes)
library(cowplot) # for grid plot

showtext_auto()
font_add(family = "raleway", regular = "Raleway-Regular.ttf")
font_add(family = "jaapokki", regular = "Jaapokki-Regular.otf")
 
```

    
```{r cache = TRUE}

# NOT WORKING PROPERLY 

# specify year range 
years <- 2010:2017

# create empty data frame
nta_mean <- data.frame(gentrified = "",
                       avg_gentri = "", 
                       avg_crime_rate_1 = "",
                       avg_crime_rate_2 = "",
                       crime_change = "",
                       year = "") 

# sadly not working
# loop over the year range to clean through datasets
for (year in years) { 
  
  # data for first year
  bk_count_1 <- crimeCount(year)
  bk_gentri_1 <- bkGentri(year)

  # data for second year
  bk_count_2 <- crimeCount(as.numeric(year + 1))
  bk_gentri_2 <- bkGentri(as.numeric(year + 1))

  #
  # gentrification change rates for first to second year
  bk_gen_1_2 <- calcChange(bk_gentri_1, bk_gentri_2)
  


  # combine gentrification and crime of year_1 & year_2
  bk_gen_crime <- mergeTracts(bk_gen_1_2, bk_count_1, bk_count_2)
   
  # get the mean for NTA e.g. mean Felony rate and change, mean Gentri score, remove BK99,
  bkg_1_2 <- calcScore(bk_gen_crime)

  # get mean value for that year, new gentri column
  nta_mean_1 <- ntaMean(bkg_1_2, year)
  
  nta_mean %>% rbind(nta_mean_1)

  # # bk_count_2010 not found
  # Error in get(paste("bk_count", earlier_year, sep = "_")) : 
  # object 'bk_count_2010' not found
}

head(nta_mean)

# split into gentrification and no gentrification
nta_mean_gentri <- nta_mean %>% 
  filter(gentrified == TRUE)

nta_mean_no_gentri <- nta_mean %>% 
  filter(gentrified == FALSE)

```
  
    
# Doing it Manually instead 

```{r cache = TRUE}

# STEP 1: getting data for each year per tract - crime (nypd) and gentrification variables (census)

# 1.1 - different types of felonies
bk_count_2010 <- crimeCount(2010) # crime 
bk_count_2011 <- crimeCount(2011) # crime 
bk_count_2012 <- crimeCount(2012) # crime 
bk_count_2013 <- crimeCount(2013) # crime 
bk_count_2014 <- crimeCount(2014) # crime 
bk_count_2015 <- crimeCount(2015) # crime 
bk_count_2016 <- crimeCount(2016) # crime 
bk_count_2017 <- crimeCount(2017) # crime 
bk_count_2018 <- crimeCount(2018) # crime 

# 1.2 - getting census variables for calculating gentrification score
bk_gentri_2010 <- bkGentri(2010) # gentrification 
bk_gentri_2011 <- bkGentri(2011) # gentrification
bk_gentri_2012 <- bkGentri(2012) # gentrification
bk_gentri_2013 <- bkGentri(2013) # gentrification
bk_gentri_2014 <- bkGentri(2014) # gentrification
bk_gentri_2015 <- bkGentri(2015) # gentrification
bk_gentri_2016 <- bkGentri(2016) # gentrification
bk_gentri_2017 <- bkGentri(2017) # gentrification
bk_gentri_2018 <- bkGentri(2018) # gentrification



# STEP 2: Calculate the gentrification score 

# changes between variables between two years by the 750 tracts
# gentrification change rates for each year 2010-2018
bk_gen_2010_2011 <- calcChange(bk_gentri_2010, bk_gentri_2011)
bk_gen_2011_2012 <- calcChange(bk_gentri_2011, bk_gentri_2012)
bk_gen_2012_2013 <- calcChange(bk_gentri_2012, bk_gentri_2013)
bk_gen_2013_2014 <- calcChange(bk_gentri_2013, bk_gentri_2014)
bk_gen_2014_2015 <- calcChange(bk_gentri_2014, bk_gentri_2015)
bk_gen_2015_2016 <- calcChange(bk_gentri_2015, bk_gentri_2016)
bk_gen_2016_2017 <- calcChange(bk_gentri_2016, bk_gentri_2017)
bk_gen_2017_2018 <- calcChange(bk_gentri_2017, bk_gentri_2018)
bk_gen_all <- calcChange(bk_gentri_2010, bk_gentri_2018)



# STEP 3: Combine gentrification and crime 

# merging tracts 
# variables by the 750 tracts AND neighborhoods between two years
bk_gen_crime_2010 <- mergeTracts(bk_gen_2010_2011, bk_count_2010, bk_count_2011)
bk_gen_crime_2011 <- mergeTracts(bk_gen_2011_2012, bk_count_2011, bk_count_2012)
bk_gen_crime_2012 <- mergeTracts(bk_gen_2012_2013, bk_count_2012, bk_count_2013)
bk_gen_crime_2013 <- mergeTracts(bk_gen_2013_2014, bk_count_2013, bk_count_2014)
bk_gen_crime_2014 <- mergeTracts(bk_gen_2014_2015, bk_count_2014, bk_count_2015)
bk_gen_crime_2015 <- mergeTracts(bk_gen_2015_2016, bk_count_2015, bk_count_2016)
bk_gen_crime_2016 <- mergeTracts(bk_gen_2016_2017, bk_count_2016, bk_count_2017)
bk_gen_crime_2017 <- mergeTracts(bk_gen_2017_2018, bk_count_2017, bk_count_2018)
bk_gen_crime_all <- mergeTracts(bk_gen_all, bk_count_2010, bk_count_2018)


# STEP 4: Keep Neighborhood tracts as granularity

# Calculate crime count and gentrification scores for neighborhood level 
# 50 Neighborhoods, Gentrification Score, Each year (2010 is the earliest) for 2010-2018
bkg_2010 <- calcScore(bk_gen_crime_2010)
bkg_2011 <- calcScore(bk_gen_crime_2011)
bkg_2012 <- calcScore(bk_gen_crime_2012)
bkg_2013 <- calcScore(bk_gen_crime_2013)
bkg_2014 <- calcScore(bk_gen_crime_2014)
bkg_2015 <- calcScore(bk_gen_crime_2015)
bkg_2016 <- calcScore(bk_gen_crime_2016)
bkg_2017 <- calcScore(bk_gen_crime_2017)
bkg_all <- calcScore(bk_gen_crime_all)


```

# Plot: Scatterplot of Gentrification & Crime - Neighborhood in Text  
  
```{r}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - # 
# ------------- PLOT: Text Scatter of Gentri & Crime -------------- # 
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - # 

# distinguishing gentrified and less gentrified neighborhoods (binary)


plot_text_scatter <- function(bkg_year, year_1, year_2) { 
  
  bk_nta <- bkg_year %>%
    select(BORO_NAME, NTA_NAME, NTA_CODE, NTA_GENTRI_SCORE, FEL_NTA_CHANGE) %>% 
    # filter(NTA_GENTRI_SCORE < 0) %>%
    distinct()
  
  ggplot(data = bk_nta) + 

    geom_text(aes(label = NTA_NAME), 
          size = 2.5, color = "#333333", family = "raleway",
          x = bk_nta$NTA_GENTRI_SCORE,
          y = bk_nta$FEL_NTA_CHANGE) +
    
    geom_hline(yintercept = 0, color = "cyan3") +
    geom_vline(xintercept = 0, color = "darksalmon") +

    ylim(min(bk_nta$FEL_NTA_CHANGE)*1.2, max(bk_nta$FEL_NTA_CHANGE)*1.2) + # felony score 
    xlim(min(bk_nta$NTA_GENTRI_SCORE)*1.2, max(bk_nta$NTA_GENTRI_SCORE)*1.2) + 
    labs(title = paste("\n", year_1, "-", year_2, "\n"),
      # title = paste("Crime and Gentrification in Brooklyn (", year_1, "-", year_2, ")\n", sep = ""),  
         x = "\nGentrification Score\n", 
         y = "\nChange in Felony Crime Rate\n") +
    theme_tufte() +
    theme(text = element_text(family = "raleway"),
          plot.title = element_text(family = "jaapokki"))

  } 

pts10 <- plot_text_scatter(bkg_2010, "2010", "2011")
pts11 <- plot_text_scatter(bkg_2011, "2011", "2012")
pts12 <- plot_text_scatter(bkg_2012, "2012", "2013")
pts13 <- plot_text_scatter(bkg_2013, "2013", "2014")
pts14 <- plot_text_scatter(bkg_2014, "2014", "2015")
pts15 <- plot_text_scatter(bkg_2015, "2015", "2016")
pts16 <- plot_text_scatter(bkg_2016, "2016", "2017")
pts17 <- plot_text_scatter(bkg_2017, "2017", "2018")
pts_all <- plot_text_scatter(bkg_all, "2010", "2018")

pts_grid <- plot_grid(pts10, pts11, pts12,
                      pts13, pts14, pts15,
                      pts16, pts17, pts_all,
                      ncol = 3)

ggsave("visualizations/plot_text_scatter_grid.pdf", pts_grid, width = 12, height = 10)
beep()

```


# Dataframe of Binary Values - Gentrified vs. Not Gentrified, for each year    
(For Time Series Lab I assignment)   
  
```{r}

# Making 
# using ntaMean function
nta_mean <- ntaMean(bkg_2011, 2011) %>% 
  bind_rows(ntaMean(bkg_2012, 2012)) %>%
  bind_rows(ntaMean(bkg_2013, 2013)) %>%
  bind_rows(ntaMean(bkg_2014, 2014)) %>% 
  bind_rows(ntaMean(bkg_2015, 2015)) %>% 
  bind_rows(ntaMean(bkg_2014, 2016)) %>% 
  bind_rows(ntaMean(bkg_2015, 2017))


nta_mean_2 <- data.frame(gentrified = "FALSE", 
                         avg_gentri = 0, 
                         avg_crime_rate_1 = nta_mean$avg_crime_rate_2[[13]], 
                         avg_crime_rate_2 = 0,
                         crime_change = 0,
                         year = 2018) 

nta_mean_3 <- data.frame(gentrified = "TRUE", 
                         avg_gentri = 0, 
                         avg_crime_rate_1 = nta_mean$avg_crime_rate_2[[14]], 
                         avg_crime_rate_2 = 0, 
                         crime_change = 0,
                         year = 2018) 


nta_mean_final <- nta_mean %>% 
  rbind(nta_mean_2) %>% 
  rbind(nta_mean_3)

# write.csv(nta_mean_final, "nta-gentri-crime-2010-2018.csv")


```
# Time Series Visualization  
  
```{r message = FALSE}

g_trend <- ggplot() +
  # plot points
  geom_point(data = nta_mean, 
             x = nta_mean$year,
             y = nta_mean$avg_crime_rate_1*100,
             group = nta_mean$gentrified) +
  # plot trend line connecting points
  geom_line(aes(x = nta_mean$year,
                y = nta_mean$avg_crime_rate_1*100,
                group = nta_mean$gentrified,
                color = nta_mean$gentrified),
                size = 1.02) +
  # legend label 
  scale_color_discrete(name = "Gentrification", labels = c("Absent", "Present")) +
  
  # tbeme elemnts
  theme_ft_rc() +
  theme(text = element_text(family = "raleway"),
        plot.title = element_text(family = "jaapokki"))


g_trend_curve <- g_trend + 
  stat_smooth(aes(x = nta_mean$year,
                  y = nta_mean$avg_crime_rate_1*100, 
                   group = nta_mean$gentrified), 
              method = "lm", 
              formula = y ~ x + I(x^2), 
              size = 0.4, 
              color = "#EFEFEF") + 
  labs(title = "\nFig. 2) Crime in Brooklyn between Gentrified & Non-Gentrified Neighborhoods\n", 
       x = "\nYear\n",
       y = "\nAverage Crime Rate (Felony)\n") 


# ggsave("visualizations/trend_analysis_curve.pdf", g_trend_curve, width = 12, height = 9)

```


# Mapping Visualizations 

```{r}

# trying to plot map but failing 

ct_map <- toSpatial(bk_gen_crime_2010)

nta_map <- toSpatial(bkg_2010)


# merged_nta <- merge(lines_bk, bkg_2010)
# # merged_nta <- merge(lines_bk, bk_nta)
# 
# nta_map <- merged_nta %>% st_transform('+proj=longlat +datum=WGS84')
# 

lines_nta_88 <- lines_bk %>%
  # group_by(NTAName) %>%
   filter(NTACode == "BK88") %>%
  st_union()

lines_bk %>%
  select(NTAName) %>%
  distinct() %>%
  dim()

names(bkg_2010)

```


```{r}
theme_set(theme_classic())
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
View(nta_map)

ggplot(data = nta_map) +
  geom_sf(aes(fill = NTA_GENTRI_SCORE), color = NA) +
  scale_fill_viridis_c(option = "magma", name = "Gentrification Score") + 
  theme_map() + 
  theme(text = element_text(family = "raleway"))  

ggplot(data = nta_map) +
  geom_sf(aes(fill = FEL_NTA_CHANGE)) + 
  scale_fill_viridis_c(option = "viridis", direction = -1)
# , limits=c(-0.015, 0.004)

ggplot(data = nta_map) + 
  geom_sf(aes(fill = FEL_NTA_PAX_1)) + 
  scale_fill_viridis_c(option = "viridis", direction = -1, limits=c(0.0061, 0.041))

ggplot(data = nta_map) + 
  geom_sf(aes(fill = FEL_NTA_CNT_2)) + 
  scale_fill_viridis_c(option = "viridis", direction = -1, limits=c(126, 3120))

typeof(nta_map)

head(nta_map)

```


