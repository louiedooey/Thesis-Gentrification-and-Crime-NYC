---
title: Thesis Code V4
output: html_notebook
author: "Louisa Ong"

--- 

```{r}
# ------------------------------------------- # 
# ------------ CRIME IN BROOKYLN ------------ #
# ------------------------------------------- # 

library(dplyr)
library(data.table)

# https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Historic/qgea-i56i
nypd  <- fread("data/NYPD-2/NYPD.csv", header = TRUE)

names(nypd)
```



```{r}
# variables renamed 
nypd_renamed <- nypd %>% 
  rename("PRECINT" = "ADDR_PCT_CD",
         "REPORTED_DATE" = "RPT_DT",
         "OFFENSE_LV" = "LAW_CAT_CD",
         "OFFENSE_DESC" = "OFNS_DESC")

# only brooklyn data and relevant column
nypd_brooklyn <- nypd_renamed %>% 
  filter(BORO_NM == "BROOKLYN") %>% 
  filter(OFFENSE_LV == "FELONY") %>% # filter to offense level of felony, the strictest
  dplyr::select(CMPLNT_NUM, # complaint serial/reference number
         PRECINT, # police dept precint of crime occurence
         REPORTED_DATE, # when the crime first happened
         OFFENSE_LV,
         OFFENSE_DESC, # more details of offense
         X_COORD_CD, Y_COORD_CD, Latitude, Longitude, Lat_Lon) # Geo details

# convert to date format
nypd_brooklyn$REPORTED_DATE = as.Date(nypd_brooklyn$REPORTED_DATE, "%m/%d/%Y")

# # filtering to only Jan 2020 Data 
# nypd_brooklyn_2018 <- nypd_brooklyn %>% 
#   dplyr::filter(COMPLAINT_DATE >= as.Date("2020-01-01") & COMPLAINT_DATE < as.Date("2020-01-02"))


# ******************** FUNCTION ************************* # 

# filter by year   
filter_year <- function(year, df) {
    
    filtered_year <- df %>%
      dplyr::filter(df$REPORTED_DATE >=
                      as.Date(paste(year, "-01-01", sep="")) &
                    df$REPORTED_DATE <=
                      as.Date(paste(year, "-12-31", sep=""))) %>% 
      na.omit()
  
    return(filtered_year)
    
}

# ******************** //////// ************************* # 

nypd_brooklyn_2010 <- filter_year(2010, nypd_brooklyn)
nypd_brooklyn_2015 <- filter_year(2015, nypd_brooklyn)
nypd_brooklyn_2016 <- filter_year(2016, nypd_brooklyn)
nypd_brooklyn_2017 <- filter_year(2017, nypd_brooklyn)
nypd_brooklyn_2018 <- filter_year(2018, nypd_brooklyn)
nypd_brooklyn_2019 <- filter_year(2019, nypd_brooklyn)

dim(nypd_brooklyn_2010)
dim(nypd_brooklyn_2016)
dim(nypd_brooklyn_2017)
dim(nypd_brooklyn_2018)
dim(nypd_brooklyn_2019)


# View(nypd_brooklyn_2016)
head(nypd_brooklyn_2018)
```

```{r}
# library(spatialEco)
library(ggplot2)
# library(maptools)
library(sf)

# convert nypd dataframe into sf/geo/spatial object 
# https://erinbecker.github.io/r-raster-vector-geospatial/10-vector-csv-to-shapefile-in-r/index.html

# read lines from tract shape file 
lines_bk <- st_read("data/boundaries/tracts/tl_2018_36_tract.shp")
# set CRS from line from tracts shp file

# convert into shapefile
pt_nypd_2018 <- st_as_sf(nypd_brooklyn_2018, coords = c("X_COORD_CD", "Y_COORD_CD"), crs = 2263)

# convert into shapefile
pt_nypd_2010 <- st_as_sf(nypd_brooklyn_2010, coords = c("X_COORD_CD", "Y_COORD_CD"), crs = 2263)


```

````{r}

 # CENSUS GEOJSON DATA from DATA.CITY OF NEW YORK  
geo_url <- "https://data.cityofnewyork.us/api/geospatial/fxpq-c8ku?method=export&format=GeoJSON"
# thank you https://mattherman.info/blog/point-in-poly/

# Get Census Tract Boundary Data 
tract_sf <- read_sf(geo_url) %>% 
  st_transform(2263) %>%
  select(ntacode, ntaname, boro_name, boro_code, boro_ct2010, ctlabel)

bk_map_2018 <- st_join(pt_nypd_2018, tract_sf, join = st_within)
names(bk_map_2018)

# get counts by tracts
bk_count_2018 <- as_tibble(bk_map_2018) %>% 
  add_count(ntaname, name = "FEL_NTA_CNT") %>% # Felony Neighborhood Count
  add_count(boro_ct2010, name = "FEL_CT_CNT") %>% # Felony Census Tract Count
  group_by(OFFENSE_DESC) %>% 
  add_count(ntaname, name = "OFN_NTA_CNT") %>% 
  add_count(boro_ct2010, name = "OFN_CT_CNT") %>% 
  rename("FELONY_TYPE" = "OFFENSE_DESC") %>% 
  filter(boro_name == "Brooklyn") %>%
  select(ntacode, ntaname, boro_name, boro_ct2010, ctlabel, FELONY_TYPE,  
         FEL_NTA_CNT, FEL_CT_CNT, OFN_NTA_CNT, OFN_CT_CNT) %>% # can include OFFENSE_LV if more than felonies
  distinct() %>% 
  na.omit()


####### 2010 Data

bk_map_2010 <- st_join(pt_nypd_2010, tract_sf, join = st_within)
# names(bk_map_2018)

# get counts by tracts
bk_count_2010 <- as_tibble(bk_map_2010) %>% 
  add_count(ntaname, name = "FEL_NTA_CNT") %>% # Felony Neighborhood Count
  add_count(boro_ct2010, name = "FEL_CT_CNT") %>% # Felony Census Tract Count
  group_by(OFFENSE_DESC) %>% 
  add_count(ntaname, name = "OFN_NTA_CNT") %>% 
  add_count(boro_ct2010, name = "OFN_CT_CNT") %>% 
  rename("FELONY_TYPE" = "OFFENSE_DESC") %>% 
  filter(boro_name == "Brooklyn") %>%
  select(ntacode, ntaname, boro_name, boro_ct2010, ctlabel, FELONY_TYPE,  
         FEL_NTA_CNT, FEL_CT_CNT, OFN_NTA_CNT, OFN_CT_CNT) %>% # can include OFFENSE_LV if more than felonies
  distinct() %>% 
  na.omit()

```


```{r}
library(tidycensus) 

# 2018 data 

# ******************** FUNCTION ************************* # 

# get census data from the year

bk_gentri <- function(year) {
  
  census_data <- get_acs(geography = "tract", # tract  
                   variables = c(TOTAL_POPN = "B01003_001E", # demographic 
                                 WHITE_ALONE = "B03002_003E",
                                 # NATIVE_BORN = "B05012_002E",
                                 FOREIGN_BORN = "B05012_003E",
                                 NO_HIGHSCH = "B06009_002E"),
                   output = "wide",
                   county = "Kings", 
                   state = "NY",
                   year = year)
  
  
  census_data %>% 
    mutate(YEAR = year)
  
} 

bk_gentri_2018 <- bk_gentri(2018)
bk_gentri_2017 <- bk_gentri(2017)
bk_gentri_2010 <- bk_gentri(2010)

# head(bk_gentri_2018)

# ******************** /////// ************************* # 

# ????????? how to do this
pct_change <- function(v1) {
  # (as.numeric(paste(v1, "x", sep=".")))/(as.numeric(paste(v1, "y", sep=".")))
  print(((paste(v1, "x", sep="."))))
}

# 
# 
# (!!sym(paste(v1, x, sep=".")))

# head(pct_change(bk_eval_17_18$WHITE_ALONE))


# Calculate change

# ******************** FUNCTION ************************* # 

calc_change <- function(year_1, year_2) {
  
  year_1 %>% 
  left_join(year_2, by = "GEOID") %>% 
  
  # calculating percentage change   
  mutate(POPN_CHANGE = (TOTAL_POPN.x/TOTAL_POPN.y*100)-100) %>% 
  mutate(WHITE_CHANGE = (WHITE_ALONE.x/TOTAL_POPN.x-WHITE_ALONE.y/TOTAL_POPN.y)*100) %>%
  mutate(FOREIGN_CHANGE = (FOREIGN_BORN.x/TOTAL_POPN.x-FOREIGN_BORN.y/TOTAL_POPN.y)*100) %>%
  mutate(NO_HS_CHANGE = (NO_HIGHSCH.x/TOTAL_POPN.x-NO_HIGHSCH.y/TOTAL_POPN.y)*100) %>%
  
  mutate(GENTRI_SCORE = (WHITE_CHANGE + FOREIGN_CHANGE - NO_HS_CHANGE)/3) %>%
  
  rename("CENSUS_TRACT" = "NAME.x", "YEAR" = "YEAR.x", "TOTAL_POPN" = "TOTAL_POPN.x") %>% 
  select(GEOID, CENSUS_TRACT, YEAR, GENTRI_SCORE, TOTAL_POPN, POPN_CHANGE, WHITE_CHANGE, FOREIGN_CHANGE, NO_HS_CHANGE) %>%
  na.omit()
  
  # year 1 is the later year 
}



# bk_gen_18 <- calc_change(bk_gentri_2018, bk_gentri_2010)
# bk_gen_1810 <- calc_change(bk_gentri_2018, bk_gentri_2010)

bk_gen_18 <- bk_gentri_2018
bk_gen_10 <- bk_gentri_2010

# View(bk_gen)
# head(bk_gen_18)
# min(bk_gen$GENTRI_SCORE) #/-10
# max(bk_gen$GENTRI_SCORE) #/10

```

```{r}
#### 

## MERGING 

## 

tracts <- read_sf("data/boundaries/tracts/tl_2018_36_tract.shp")

bk_geoid_2010 <- merge(tracts, bk_gen_10, by.x="GEOID", by.y="GEOID")
bk_geoid_2018 <- merge(tracts, bk_gen_18, by.x="GEOID", by.y="GEOID")

bk_geoid_2010_df <- as_tibble(bk_geoid_2010)
bk_geoid_2018_df <- as_tibble(bk_geoid_2018)


bk_gentri_crime_2010 <- bk_geoid_2010_df %>% 
  rename("ctlabel" = "NAME.x") %>% 
  left_join(bk_count_2010, by = "ctlabel") %>%
  # mutate(OFN_NTA_PAX = OFN_NTA_CNT/TOTAL_POPN) %>%
  # mutate(OFN_CT_PAX = OFN_CT_CNT/TOTAL_POPN) %>%
  mutate(FEL_NTA_PAX = FEL_NTA_CNT/TOTAL_POPN) %>%
  mutate(FEL_CT_PAX = FEL_CT_CNT/TOTAL_POPN) %>%
  select("boro_name", "YEAR",
         "GEOID", "ntaname", "ntacode", "boro_ct2010", "ctlabel",
         "TOTAL_POPN", "WHITE_ALONE", "FOREIGN_BORN", "NO_HIGHSCH",
         "FEL_NTA_PAX", "FEL_NTA_CNT",
         "FEL_CT_PAX", "FEL_CT_CNT") %>%
         # "OFN_NTA_PAX", "OFN_NTA_CNT",
         # "OFN_CT_PAX", "OFN_CT_CNT") %>%
  distinct() %>%
  na.omit()


bk_gentri_crime_2018 <- bk_geoid_2018_df %>% 
  rename("ctlabel" = "NAME.x") %>% 
  left_join(bk_count_2018, by = "ctlabel") %>%
  # mutate(OFN_NTA_PAX = OFN_NTA_CNT/TOTAL_POPN) %>%
  # mutate(OFN_CT_PAX = OFN_CT_CNT/TOTAL_POPN) %>%
  mutate(FEL_NTA_PAX = FEL_NTA_CNT/TOTAL_POPN) %>%
  mutate(FEL_CT_PAX = FEL_CT_CNT/TOTAL_POPN) %>%
  select("boro_name", "YEAR",
         "GEOID", "ntaname", "ntacode", "boro_ct2010", "ctlabel",
         "TOTAL_POPN", "WHITE_ALONE", "FOREIGN_BORN", "NO_HIGHSCH",
         "FEL_NTA_PAX", "FEL_NTA_CNT",
         "FEL_CT_PAX", "FEL_CT_CNT") %>%
         # "OFN_NTA_PAX", "OFN_NTA_CNT",
         # "OFN_CT_PAX", "OFN_CT_CNT") %>%
  distinct() %>%
  na.omit()

bk_ord_2018 <- bk_gentri_crime_2018[order(bk_gentri_crime_2018$ntacode),]
bk_ord_2010 <- bk_gentri_crime_2010[order(bk_gentri_crime_2010$ntacode),]

dim(bk_ord_2018)
dim(bk_ord_2010)

bk_ord_2018["TOTAL_POPN"]-bk_ord_2010["TOTAL_POPN"]

head(bk_gentri_crime_2018)

```

# bk_gentri_crime_2018 <- bk_geoid_2018_df %>% 
#   rename("ctlabel" = "NAME") %>% 
#   left_join(bk_count_2018, by = "ctlabel") %>%
#   mutate(OFN_NTA_PAX = OFN_NTA_CNT/TOTAL_POPN) %>%
#   mutate(OFN_CT_PAX = OFN_CT_CNT/TOTAL_POPN) %>%
#   mutate(FEL_NTA_PAX = FEL_NTA_CNT/TOTAL_POPN) %>%
#   mutate(FEL_CT_PAX = FEL_CT_CNT/TOTAL_POPN) %>%
#   select("boro_name", "YEAR", 
#          "GEOID", "ntaname", "ntacode", "boro_ct2010", "ctlabel",
#          "GENTRI_SCORE", "TOTAL_POPN", "POPN_CHANGE", "WHITE_CHANGE", "FOREIGN_CHANGE", "NO_HS_CHANGE",
#          "FELONY_TYPE", 
#          "FEL_NTA_PAX", "FEL_NTA_CNT", 
#          "FEL_CT_PAX", "FEL_CT_CNT", 
#          "OFN_NTA_PAX", "OFN_NTA_CNT", 
#          "OFN_CT_PAX", "OFN_CT_CNT") 

# 
# calc_change <- function(year_1, year_2) {
#   
#   year_1 %>% 
#   left_join(year_2, by = "GEOID") %>% 
#   
#   # calculating percentage change   
#   mutate(POPN_CHANGE = (TOTAL_POPN.x/TOTAL_POPN.y*100)-100) %>% 
#   mutate(WHITE_CHANGE = (WHITE_ALONE.x/TOTAL_POPN.x-WHITE_ALONE.y/TOTAL_POPN.y)*100) %>%
#   mutate(FOREIGN_CHANGE = (FOREIGN_BORN.x/TOTAL_POPN.x-FOREIGN_BORN.y/TOTAL_POPN.y)*100) %>%
#   mutate(NO_HS_CHANGE = (NO_HIGHSCH.x/TOTAL_POPN.x-NO_HIGHSCH.y/TOTAL_POPN.y)*100) %>%
#   
#   mutate(GENTRI_SCORE = (WHITE_CHANGE + FOREIGN_CHANGE - NO_HS_CHANGE)/3) %>%
#   
#   rename("CENSUS_TRACT" = "NAME.x", "YEAR" = "YEAR.x", "TOTAL_POPN" = "TOTAL_POPN.x") %>% 
#   select(GEOID, CENSUS_TRACT, YEAR, GENTRI_SCORE, TOTAL_POPN, POPN_CHANGE, WHITE_CHANGE, FOREIGN_CHANGE, NO_HS_CHANGE) %>%
#   na.omit() 
#   
#   # year 1 is the later year 
# }

join_2018_2010 <- bk_gentri_crime_2018 %>%
  left_join(bk_gentri_crime_2010, by = "GEOID")





final_CT_2018 <- join_2018_2010 %>%
  mutate(POPN_CHANGE = (TOTAL_POPN.x/TOTAL_POPN.y*100)-100) %>% 
  mutate(WHITE_CHANGE = (WHITE_ALONE.x/TOTAL_POPN.x-WHITE_ALONE.y/TOTAL_POPN.y)*100) %>%
  mutate(FOREIGN_CHANGE = (FOREIGN_BORN.x/TOTAL_POPN.x - FOREIGN_BORN.y/TOTAL_POPN.y)*100) %>%
  mutate(NO_HS_CHANGE = (NO_HIGHSCH.x/TOTAL_POPN.x - NO_HIGHSCH.y/TOTAL_POPN.y)*100) %>%
  mutate(GENTRI_SCORE = (WHITE_CHANGE + FOREIGN_CHANGE - NO_HS_CHANGE)/3) %>%
  
  mutate(FEL_PAX_CHANGE = (FEL_CT_PAX.x/TOTAL_POPN.x - FEL_CT_PAX.y/TOTAL_POPN.y)*100) %>%
  # mutate(OFN_PAX_CHANGE = (OFN_CT_PAX.x/TOTAL_POPN.x - OFN_CT_PAX.y/TOTAL_POPN.y)*100) %>%

  rename("BORO" = "boro_name.x",
         "YEAR" = "YEAR.x", 
         "NTA" = "ntaname.x",
         "NTACODE" = "ntacode.x", 
         "BORO_CT" = "boro_ct2010.x", 
         "CENSUS_NO" = "ctlabel.x", 
         "POPN_2018" = "TOTAL_POPN.") %>% #"FELONY_TYPE" = "FELONY_TYPE.x"
  select(BORO, YEAR, GEOID, NTA, NTACODE, BORO_CT, CENSUS_NO, POPN_2018, POPN_CHANGE, WHITE_CHANGE, FOREIGN_CHANGE, NO_HS_CHANGE, GENTRI_SCORE, FEL_PAX_CHANGE) %>%  #FELONY TYPE, OFN_PAX_CHANGE
  distinct() %>%
  na.omit()

final_NTA_2018 <- final_CT_2018 %>% 
  group_by(NTA) %>%
  summarise(BORO = first(BORO),
            YEAR = first(YEAR),
            NTA = first(NTA), 
            NTACODE = first(NTACODE),
            POPN_2018 = sum(POPN_2018),
            GENTRI_SCORE_NTA = mean(GENTRI_SCORE),
            WHITE_CHANGE_NTA = mean(WHITE_CHANGE),
            FOREIGN_CHANGE_NTA = mean(FOREIGN_CHANGE),
            NO_HS_CHANGE_NTA = mean(NO_HS_CHANGE),
            FEL_PAX_CHANGE_NTA = mean(FEL_PAX_CHANGE))

View(final_NTA_2018)

View(final_2018)


write.csv(final_CT_2018, "data/final_gentri_crime_CT_2010_2018.csv")
write.csv(final_NTA_2018, "data/final_gentri_crime_NTA_2010_2018.csv")


```


```{r}
# ******************** FUNCTION ************************* # 

calc_change <- function(year_1, year_2) {
  
  year_1 %>% 
  left_join(year_2, by = "GEOID") %>% 
  
  # calculating percentage change   
  mutate(POPN_CHANGE = (TOTAL_POPN.x/TOTAL_POPN.y*100)-100) %>% 
  mutate(WHITE_CHANGE = (WHITE_ALONE.x/TOTAL_POPN.x-WHITE_ALONE.y/TOTAL_POPN.y)*100) %>%
  mutate(FOREIGN_CHANGE = (FOREIGN_BORN.x/TOTAL_POPN.x-FOREIGN_BORN.y/TOTAL_POPN.y)*100) %>%
  mutate(NO_HS_CHANGE = (NO_HIGHSCH.x/TOTAL_POPN.x-NO_HIGHSCH.y/TOTAL_POPN.y)*100) %>%
  
  mutate(GENTRI_SCORE = (WHITE_CHANGE + FOREIGN_CHANGE - NO_HS_CHANGE)/3) %>%
  
  rename("CENSUS_TRACT" = "NAME.x", "YEAR" = "YEAR.x", "TOTAL_POPN" = "TOTAL_POPN.x") %>% 
  select(GEOID, CENSUS_TRACT, YEAR, GENTRI_SCORE, TOTAL_POPN, POPN_CHANGE, WHITE_CHANGE, FOREIGN_CHANGE, NO_HS_CHANGE) %>%
  na.omit()
  
  # year 1 is the later year 
}
```


<!-- ```{r} -->
<!-- ### ------------------------------------------ ### -->
<!-- # ------------ NTA + NYPD + TLINE -------------- # -->
<!-- ### ------------------------------------------ ### -->


<!-- # imported from QGIS: neighborhoods, geoid (census tracts), crime for 2018 -->
<!-- nta_geoid_crime_2018 <- read.csv("data/nta-geoid-crime/2018/nta-geoid-crime-2018-2.csv")  -->

<!-- # shorten variable name -->
<!-- ngc <- nta_geoid_crime_2018I -->
<!-- ``` -->


<!-- ```{r} -->

<!-- read.csv("") -->
<!-- ``` -->



<!-- ```{r} -->
<!-- # ---------------------------------------------- #  -->
<!-- # ------------ BROOKLYN BOUNDARIES  ------------ # -->
<!-- # --------------------------------------- ------ #  -->

<!-- # downloaded from https://www1.nyc.gov/site/planning/data-maps/open-data/dwn-nynta.page -->
<!-- ny_boundaries <- read.csv("data/boundaries/nynta.csv")  -->

<!-- brooklyn_boundaries <- ny_boundaries %>% -->
<!--   filter(BoroName == "Brooklyn") -->

<!-- # View(brooklyn_boundaries) -->

<!-- dim(ny_boundaries) -->

<!-- ``` -->


<!-- ```{r} -->
<!-- install.packages('tidycensus') -->

<!-- library(sf) -->



<!-- ``` -->

